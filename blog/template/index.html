<!doctype html><html lang=en><head><script async defer data-website-id=6023252a-3a97-470f-b4ee-5082d242bb9a src=https://umami.pourtan.eu/umami.js></script><meta charset=utf-8><meta name=generator content="Hugo 0.102.3"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Raphael Sourty"><meta property="og:url" content="https://raphaelsty.github.io/blog/template/"><link rel=canonical href=https://raphaelsty.github.io/blog/template/><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦”</text></svg>"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/raphaelsty.github.io\/"},"articleSection":"blog","name":"Extractive Question Answering application.","headline":"Extractive Question Answering application.","description":"This blog post is a response to Max Halford\u0026rsquo;s blog post \u0026ldquo;NLP at Carbonfact: how would you do it?\nIn his blog post, Max proposes a procedure to automate a part of clothes\u0026rsquo; life cycle analysis (LCA). The LCA aims, among other things, to estimate the amount of carbon needed to produce a good.\nThe specific task he is working to solve is to identify named entities and create structured data from those entities.","inLanguage":"en-US","author":"Raphael Sourty","creator":"Raphael Sourty","publisher":"Raphael Sourty","accountablePerson":"Raphael Sourty","copyrightHolder":"Raphael Sourty","copyrightYear":"2022","datePublished":"2022-09-06 00:00:00 \u002b0000 UTC","dateModified":"2022-09-06 00:00:00 \u002b0000 UTC","url":"https:\/\/raphaelsty.github.io\/blog\/template\/","keywords":[]}</script><title>Extractive Question Answering application. â€¢ Raphael Sourty</title><meta property="og:title" content="Extractive Question Answering application. â€¢ Raphael Sourty"><meta property="og:type" content="article"><meta name=description content="This blog post is a response to Max Halford&rsquo;s blog post &ldquo;NLP at Carbonfact: how would you do it?
In his blog post, Max proposes a procedure to automate a part of clothes&rsquo; life cycle analysis (LCA). The LCA aims, among other things, to estimate the amount of carbon needed to produce a good.
The specific task he is working to solve is to identify named entities and create structured data from those entities."><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/github-markdown.min.css><link rel=stylesheet href=/css/highlight/github.css><link rel=stylesheet href=/css/index.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Permanent+Marker&display=swap" rel=stylesheet><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><article class=post id=article><div class="row center-xs" style=text-align:left><div class="col-xs-12 col-sm-10 col-md-7 col-lg-5"><div class=post-header><header><div class="signatures site-title"><a href=/>Raphael Sourty - Welcome</a></div></header><div class="row end-xs"><div><a class=header-link href=/>Blog</a>
<a class=header-link href=/links/>Links</a>
<a class=header-link href=/bio/>Bio</a></div></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>Extractive Question Answering application.</h1><div class="row post-desc"><div class=col-xs-12><time class=post-date datetime="2022-09-06 00:00:00 UTC">2022-09-06 Â· 3779 words</time></div></div></header><div class="post-content markdown-body"><p>This blog post is a response to Max Halford&rsquo;s blog post <a href=https://maxhalford.github.io/blog/carbonfact-nlp-open-problem/>&ldquo;NLP at Carbonfact: how would you do it?</a></p><p>In his blog post, Max proposes a procedure to automate a part of clothes&rsquo; life cycle analysis (LCA). The LCA aims, among other things, to estimate the amount of carbon needed to produce a good.</p><p>The specific task he is working to solve is to identify named entities and create structured data from those entities. But here&rsquo;s the thing: Max&rsquo;s clients&rsquo; data all have distinct formats, so much so that they agreed to have to write custom data normalization logic for each of their clients.</p><p>Sample data is available for <a href=https://maxhalford.github.io/files/datasets/nlp-carbonfact/inputs.txt>download</a>; this is what they look like:</p><pre tabindex=0><code>lace 87% nylon 13% spandex; mesh: 95% nylon 5% spandex
</code></pre><p>Max&rsquo;s objective is to extract the structured information associated with these descriptions. He manually annotated the above data to facilitate information extraction via a machine learning algorithm. The ground truth is also available for <a href=https://maxhalford.github.io/files/datasets/nlp-carbonfact/outputs.json>download</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lace&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;nylon&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>87.0</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>13.0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;mesh&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;nylon&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>95.0</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>5.0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In the context of this response, my objective is to propose a model capable of adapting to different formats to facilitate the annotation of new data and to define a baseline for future improvement. My solution comprises an extractive question-answering model dedicated to entity recognition and an information retrieval pipeline for their disambiguation.</p><details><summary>Click here to see the version of the Python packages I use in the tutorial.</summary><p>Transformer training packages:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=err>!</span><span class=n>pip</span> <span class=n>install</span> <span class=n>transformers</span><span class=o>==</span><span class=mf>4.17.0</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=n>pip</span> <span class=n>install</span> <span class=n>datasets</span><span class=o>==</span><span class=mf>2.0.0</span>
</span></span></code></pre></div><p>Packages dedicated to inference:</p><pre tabindex=0><code class=language-pyhon data-lang=pyhon>!pip install cherche==0.8.0
!pip install transformers==4.17.0
!pip install spacy==3.3.0
!python -m spacy download en_core_web_sm
</code></pre></details><h2 id=question-answering-dataset>Question-answering dataset</h2><p>Let&rsquo;s start by creating a dataset from the annotated data to train a question-answering model.</p><p>For each item, we can create sample questions to identify:</p><ul><li>Components: <code>What is the {i-th} component ?</code></li><li>Materials and proportions: <code>What is the {i-th} material of the component {component} ?</code></li></ul><pre tabindex=0><code>body: 83% nylon 17% spandex; lace: 86% nylon 14% spandex
</code></pre><p>The following are examples of questions on components.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;answers&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;answer_start&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=nt>&#34;text&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;body&#34;</span><span class=p>]},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;context&#34;</span><span class=p>:</span> <span class=s2>&#34;[NONE] body 83 nylon 17 spandex lace 86 nylon 14 spandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;What is the 1 component ?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;answers&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;answer_start&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mi>32</span><span class=p>],</span> <span class=nt>&#34;text&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;lace&#34;</span><span class=p>]},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;context&#34;</span><span class=p>:</span> <span class=s2>&#34;[NONE] body 83 nylon 17 spandex lace 86 nylon 14 spandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;What is the 2 component ?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>Some examples do not have components specified, so we concatenate the <code>[NONE]</code> tag in front of all the documents in the corpus and ask the model to mention the tag when this is the case.</p><p>The following are examples of questions for materials and proportions. We combine proportions and materials because they follow each other systematically in the training data. Furthermore, we will have to make a single call to our model to extract both pieces of information, saving us computing power.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;answers&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;answer_start&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mi>12</span><span class=p>],</span> <span class=nt>&#34;text&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;83 nylon&#34;</span><span class=p>]},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;context&#34;</span><span class=p>:</span> <span class=s2>&#34;[NONE] body 83 nylon 17 spandex lace 86 nylon 14 spandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;What is the 1 material of the component body ?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;answers&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;answer_start&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mi>21</span><span class=p>],</span> <span class=nt>&#34;text&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;17 spandex&#34;</span><span class=p>]},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;context&#34;</span><span class=p>:</span> <span class=s2>&#34;[NONE] body 83 nylon 17 spandex lace 86 nylon 14 spandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;What is the 2 material of the component body ?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;answers&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;answer_start&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mi>37</span><span class=p>],</span> <span class=nt>&#34;text&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;86 nylon&#34;</span><span class=p>]},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;context&#34;</span><span class=p>:</span> <span class=s2>&#34;[NONE] body 83 nylon 17 spandex lace 86 nylon 14 spandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;What is the 1 material of the component lace ?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;answers&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;answer_start&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mi>46</span><span class=p>],</span> <span class=nt>&#34;text&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;14 spandex&#34;</span><span class=p>]},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;context&#34;</span><span class=p>:</span> <span class=s2>&#34;[NONE] body 83 nylon 17 spandex lace 86 nylon 14 spandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;What is the 2 material of the component lace ?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p><strong>We create 2639 questions from 600 descriptions or an average of 4.39 questions per document. Then, we divide these questions into 2139 training questions and 500 testing questions dedicated to evaluating our model.</strong></p><p>Here is the code to create the train and test datasets:</p><details><summary>Click to see the code.</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Keeps some of the pre-processing to increase the amount of training data.</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>replace</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;top body&#34;</span><span class=p>,</span> <span class=s2>&#34;top_body&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;op body&#34;</span><span class=p>,</span> <span class=s2>&#34;top_body&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;body &amp; panty&#34;</span><span class=p>,</span> <span class=s2>&#34;body_panty&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;edge lace&#34;</span><span class=p>,</span> <span class=s2>&#34;edge_lace&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;edg lace&#34;</span><span class=p>,</span> <span class=s2>&#34;edge_lace&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;cup shell&#34;</span><span class=p>,</span> <span class=s2>&#34;cup_shell&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;centre front and wings&#34;</span><span class=p>,</span> <span class=s2>&#34;centre_front_and_wings&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;cup lining&#34;</span><span class=p>,</span> <span class=s2>&#34;cup_lining&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;front panel&#34;</span><span class=p>,</span> <span class=s2>&#34;front_panel&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;back panel&#34;</span><span class=p>,</span> <span class=s2>&#34;back_panel&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;marl fabric&#34;</span><span class=p>,</span> <span class=s2>&#34;marl_fabric&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;knited top&#34;</span><span class=p>,</span> <span class=s2>&#34;knitted_top&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;striped mesh&#34;</span><span class=p>,</span> <span class=s2>&#34;striped_mesh&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;trim lace&#34;</span><span class=p>,</span> <span class=s2>&#34;trim_lace&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;trim lace&#34;</span><span class=p>,</span> <span class=s2>&#34;trim_lace&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># typos</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;sapndex&#34;</span><span class=p>,</span> <span class=s2>&#34;spandex&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;spadnex&#34;</span><span class=p>,</span> <span class=s2>&#34;spandex&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;spandexndex&#34;</span><span class=p>,</span> <span class=s2>&#34;spandex&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;span$&#34;</span><span class=p>,</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;spande$&#34;</span><span class=p>,</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polyest &#34;</span><span class=p>,</span> <span class=s2>&#34;polyester &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;polyeste$&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;poly$&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polyster&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polyeste &#34;</span><span class=p>,</span> <span class=s2>&#34;polyester &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;elastanee&#34;</span><span class=p>,</span> <span class=s2>&#34;elastane&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34; poly &#34;</span><span class=p>,</span> <span class=s2>&#34; polyester &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;cotton algodÃ³n coton&#34;</span><span class=p>,</span> <span class=s2>&#34;cotton&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;poliamide&#34;</span><span class=p>,</span> <span class=s2>&#34;polyamide&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;recycle polyamide&#34;</span><span class=p>,</span> <span class=s2>&#34;recycled polyamide&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polyester poliÃ©ster&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polystester&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;regualar polyamide&#34;</span><span class=p>,</span> <span class=s2>&#34;regular polyamide&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;recycle nylon&#34;</span><span class=p>,</span> <span class=s2>&#34;recycled nylon&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;buttom&#34;</span><span class=p>,</span> <span class=s2>&#34;bottom&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;recycle polyester&#34;</span><span class=p>,</span> <span class=s2>&#34;recycled polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;125&#34;</span><span class=p>,</span> <span class=s2>&#34;12%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;135&#34;</span><span class=p>,</span> <span class=s2>&#34;13%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;recycled polyeser&#34;</span><span class=p>,</span> <span class=s2>&#34;recycled polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polyeter&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polyeseter&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;viscouse&#34;</span><span class=p>,</span> <span class=s2>&#34;viscose&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;ctton&#34;</span><span class=p>,</span> <span class=s2>&#34;cotton&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;ryaon&#34;</span><span class=p>,</span> <span class=s2>&#34;rayon&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;./data/inputs.txt&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>readlines</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;./data/outputs.json&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>outputs</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>inputs</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>outputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>questions</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>inputs</span><span class=p>,</span> <span class=n>outputs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>replace</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;[^a-zA-Z0-9 </span><span class=se>\n</span><span class=s2>\.]&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;\s\s+&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;[NONE] </span><span class=si>{</span><span class=n>x</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Sort the components according to the order in which they appear in the sentence.</span>
</span></span><span class=line><span class=cl>    <span class=n>components</span> <span class=o>=</span> <span class=p>{</span><span class=n>component</span><span class=p>:</span> <span class=n>x</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>component</span><span class=p>)</span> <span class=k>for</span> <span class=n>component</span> <span class=ow>in</span> <span class=n>y</span><span class=o>.</span><span class=n>keys</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>    <span class=n>components</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=nb>sorted</span><span class=p>(</span><span class=n>components</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>item</span><span class=p>:</span> <span class=n>item</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Ask for components</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>index</span><span class=p>,</span> <span class=n>component</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>components</span><span class=o>.</span><span class=n>keys</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Sometimes there isn&#39;t any component.</span>
</span></span><span class=line><span class=cl>        <span class=c1># We will ask the model to return [NONE].</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>component</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>component</span> <span class=o>=</span> <span class=s2>&#34;[NONE]&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>x</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>component</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;answers&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;answer_start&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>x</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>component</span><span class=p>)],</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>component</span><span class=p>]},</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>x</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;What is the </span><span class=si>{</span><span class=n>index</span> <span class=o>+</span> <span class=mi>1</span><span class=si>}</span><span class=s2> component ?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># We want to avoid missing a component and asking the model to retrieve the n+1</span>
</span></span><span class=line><span class=cl>        <span class=c1># component while requesting the nth component.</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>questions</span> <span class=o>+=</span> <span class=n>q</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Ask for materials</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>component</span><span class=p>,</span> <span class=n>materials</span> <span class=ow>in</span> <span class=n>y</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>component</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>component</span> <span class=o>=</span> <span class=s2>&#34;[NONE]&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>index</span><span class=p>,</span> <span class=n>material</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>materials</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>proportion</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>material</span><span class=p>[</span><span class=s2>&#34;proportion&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>material</span> <span class=o>=</span> <span class=n>material</span><span class=p>[</span><span class=s2>&#34;material&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>found</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># We match patterns like &#34;20 cotton&#34; and &#34;20 cotton&#34;.</span>
</span></span><span class=line><span class=cl>            <span class=c1># We keep both the proportion and the material in the answer to avoid</span>
</span></span><span class=line><span class=cl>            <span class=c1># calling the pattern twice. We will extract the proportion and material</span>
</span></span><span class=line><span class=cl>            <span class=c1># from the answer later.</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>material</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>proportion</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>proportion</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>material</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>x</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>pattern</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>questions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;answers&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;answer_start&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>x</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>pattern</span><span class=p>)],</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>pattern</span><span class=p>]},</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>x</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;What is the </span><span class=si>{</span><span class=n>index</span> <span class=o>+</span> <span class=mi>1</span><span class=si>}</span><span class=s2> material of the component </span><span class=si>{</span><span class=n>component</span><span class=si>}</span><span class=s2> ?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>test</span> <span class=o>=</span> <span class=n>questions</span><span class=p>[:</span><span class=mi>500</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>train</span> <span class=o>=</span> <span class=n>questions</span><span class=p>[</span><span class=mi>500</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;data/train.json&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>train</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>row</span><span class=p>,</span> <span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;data/test.json&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>test</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>row</span><span class=p>,</span> <span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div></details><h2 id=question-answering-fine-tuning>Question-answering fine-tuning</h2><p>Here is the boring part; I copied and pasted the <a href=https://huggingface.co/docs/transformers/tasks/question_answering>Hugging Face code</a> dedicated to training question-answering models. It seems that learning Pytorch is no longer helpful for NLP.</p><p>I chose to fine-tune the extractive question answering model <a href=https://huggingface.co/deepset/tinyroberta-squad2>deepset/tinyroberta-squad2</a> because it is light and powerful. Note that the model is specialized in English. Training the model for ten epochs and 2139 questions takes 10 minutes on a GPU.</p><p>Here is the code dedicated to the specialization of the model on our dataset:</p><details><summary>Click to see the code.</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datasets</span> <span class=kn>import</span> <span class=n>load_dataset</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>transformers</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>AutoModelForQuestionAnswering</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>AutoTokenizer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>DefaultDataCollator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Trainer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>TrainingArguments</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>AutoTokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=s2>&#34;deepset/tinyroberta-squad2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>AutoModelForQuestionAnswering</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=s2>&#34;deepset/tinyroberta-squad2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dataset</span> <span class=o>=</span> <span class=n>load_dataset</span><span class=p>(</span><span class=s2>&#34;json&#34;</span><span class=p>,</span> <span class=n>data_files</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;train&#34;</span><span class=p>:</span> <span class=s2>&#34;data/train.json&#34;</span><span class=p>,</span> <span class=s2>&#34;test&#34;</span><span class=p>:</span> <span class=s2>&#34;data/test.json&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>preprocess_function</span><span class=p>(</span><span class=n>examples</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>questions</span> <span class=o>=</span> <span class=p>[</span><span class=n>q</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span> <span class=k>for</span> <span class=n>q</span> <span class=ow>in</span> <span class=n>examples</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>questions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>examples</span><span class=p>[</span><span class=s2>&#34;context&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>max_length</span><span class=o>=</span><span class=mi>384</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>truncation</span><span class=o>=</span><span class=s2>&#34;only_second&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>return_offsets_mapping</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>padding</span><span class=o>=</span><span class=s2>&#34;max_length&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>offset_mapping</span> <span class=o>=</span> <span class=n>inputs</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&#34;offset_mapping&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>answers</span> <span class=o>=</span> <span class=n>examples</span><span class=p>[</span><span class=s2>&#34;answers&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>start_positions</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>end_positions</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>offset</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>offset_mapping</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>answer</span> <span class=o>=</span> <span class=n>answers</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>start_char</span> <span class=o>=</span> <span class=n>answer</span><span class=p>[</span><span class=s2>&#34;answer_start&#34;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>end_char</span> <span class=o>=</span> <span class=n>answer</span><span class=p>[</span><span class=s2>&#34;answer_start&#34;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>answer</span><span class=p>[</span><span class=s2>&#34;text&#34;</span><span class=p>][</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>sequence_ids</span> <span class=o>=</span> <span class=n>inputs</span><span class=o>.</span><span class=n>sequence_ids</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Find the start and end of the context</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>sequence_ids</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>context_start</span> <span class=o>=</span> <span class=n>idx</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>sequence_ids</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>context_end</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># If the answer is not fully inside the context, label it (0, 0)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>offset</span><span class=p>[</span><span class=n>context_start</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>end_char</span> <span class=ow>or</span> <span class=n>offset</span><span class=p>[</span><span class=n>context_end</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>start_char</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>start_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>end_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Otherwise it&#39;s the start and end token positions</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=n>context_start</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=n>idx</span> <span class=o>&lt;=</span> <span class=n>context_end</span> <span class=ow>and</span> <span class=n>offset</span><span class=p>[</span><span class=n>idx</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>start_char</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>start_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>idx</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=n>context_end</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=n>idx</span> <span class=o>&gt;=</span> <span class=n>context_start</span> <span class=ow>and</span> <span class=n>offset</span><span class=p>[</span><span class=n>idx</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>end_char</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>idx</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>end_positions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span><span class=p>[</span><span class=s2>&#34;start_positions&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>start_positions</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span><span class=p>[</span><span class=s2>&#34;end_positions&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>end_positions</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>inputs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tokenized</span> <span class=o>=</span> <span class=n>dataset</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>preprocess_function</span><span class=p>,</span> <span class=n>batched</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>training_args</span> <span class=o>=</span> <span class=n>TrainingArguments</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>output_dir</span><span class=o>=</span><span class=s2>&#34;./results&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluation_strategy</span><span class=o>=</span><span class=s2>&#34;epoch&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>learning_rate</span><span class=o>=</span><span class=mf>3e-5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>per_device_train_batch_size</span><span class=o>=</span><span class=mi>16</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>per_device_eval_batch_size</span><span class=o>=</span><span class=mi>16</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>num_train_epochs</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>weight_decay</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>trainer</span> <span class=o>=</span> <span class=n>Trainer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span><span class=o>=</span><span class=n>training_args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>train_dataset</span><span class=o>=</span><span class=n>tokenized</span><span class=p>[</span><span class=s2>&#34;train&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>eval_dataset</span><span class=o>=</span><span class=n>tokenized</span><span class=p>[</span><span class=s2>&#34;test&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>tokenizer</span><span class=o>=</span><span class=n>tokenizer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data_collator</span><span class=o>=</span><span class=n>DefaultDataCollator</span><span class=p>(),</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>trainer</span><span class=o>.</span><span class=n>train</span><span class=p>()</span>
</span></span></code></pre></div></details><h2 id=inference-using-the-extractive-question-answering-model>Inference using the extractive question-answering model</h2><p>I uploaded the model to the Hugging Face hub after training it to make it easier to reuse. Its name is <a href=https://huggingface.co/raphaelsty/carbonblog>raphaelsty/carbonblog</a>.</p><p>Let&rsquo;s look at how our model generalizes with our template questions on some examples of the test set:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>transformers</span> <span class=kn>import</span> <span class=n>pipeline</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>qa</span> <span class=o>=</span> <span class=n>pipeline</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;question-answering&#34;</span><span class=p>,</span> <span class=n>model</span><span class=o>=</span><span class=s2>&#34;raphaelsty/carbonblog&#34;</span><span class=p>,</span> <span class=n>tokenizer</span><span class=o>=</span><span class=s2>&#34;raphaelsty/carbonblog&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>clean</span><span class=p>(</span><span class=n>document</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Pre-process the document.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>document</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;[^a-zA-Z0-9 </span><span class=se>\n</span><span class=s2>\.]&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=n>document</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>document</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;\s\s+&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=n>document</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># [NONE] allows the model to handle missing components.</span>
</span></span><span class=line><span class=cl>    <span class=n>document</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;[NONE] </span><span class=si>{</span><span class=n>document</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>document</span>
</span></span></code></pre></div><p>Let&rsquo;s start with pre-processing the documents; we remove the special characters.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>document</span> <span class=o>=</span> <span class=n>clean</span><span class=p>(</span><span class=s2>&#34;body: 83% nylon 17</span><span class=si>% s</span><span class=s2>pandex; lace: 86% nylon 14</span><span class=si>% s</span><span class=s2>pandex&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>We can then interrogate our model on the first mentioned component.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>qa</span><span class=p>({</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;What is the 1 component ?&#34;</span><span class=p>,</span> <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>document</span><span class=p>})</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>,</span> <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=mi>7</span><span class=p>,</span> <span class=nt>&#34;end&#34;</span><span class=p>:</span> <span class=mi>11</span><span class=p>,</span> <span class=nt>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;body&#34;</span><span class=p>}</span>
</span></span></code></pre></div><p>The second component:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>qa</span><span class=p>({</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;What is the 2 component ?&#34;</span><span class=p>,</span> <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>document</span><span class=p>})</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>0.9999976754188538</span><span class=p>,</span> <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=mi>32</span><span class=p>,</span> <span class=nt>&#34;end&#34;</span><span class=p>:</span> <span class=mi>36</span><span class=p>,</span> <span class=nt>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;lace&#34;</span><span class=p>}</span>
</span></span></code></pre></div><p>The material (and its proportion) most present in the body component:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>qa</span><span class=p>({</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;What is the 1 material of the component body ?&#34;</span><span class=p>,</span> <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>document</span><span class=p>})</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>0.9999743103981018</span><span class=p>,</span> <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=mi>12</span><span class=p>,</span> <span class=nt>&#34;end&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span> <span class=nt>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;83 nylon&#34;</span><span class=p>}</span>
</span></span></code></pre></div><p>The second most present material (and its proportion) in the lace component:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>qa</span><span class=p>({</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;What is the 2 material of the component lace ?&#34;</span><span class=p>,</span> <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>document</span><span class=p>})</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>0.9999875426292419</span><span class=p>,</span> <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=mi>46</span><span class=p>,</span> <span class=nt>&#34;end&#34;</span><span class=p>:</span> <span class=mi>56</span><span class=p>,</span> <span class=nt>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;14 spandex&#34;</span><span class=p>}</span>
</span></span></code></pre></div><h2 id=automatic-extraction>Automatic extraction</h2><p>We have a model capable of locating components, materials, and proportions based on questions. Here the idea is simple; we will automate the processing of documents.</p><p>We need to identify the number of components and the number of materials associated with each component.</p><p>In the document below, two times percentages sum to 100, so there are two components and two materials for each.</p><pre tabindex=0><code>body: 83% nylon 17% spandex; lace: 86% nylon 14% spandex
</code></pre><p>Following this logic, we can automate the identification of the number of components and the number of materials associated with each of these components. We can then generate question templates to structure the data.</p><p>The code below automates the generation of questions for a given document:</p><details><summary>Click to see the code</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>collections</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>n_components_materials</span><span class=p>(</span><span class=n>tokenizer</span><span class=p>,</span> <span class=n>document</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Extract the number of components and materials per component.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>component</span><span class=p>,</span> <span class=n>material</span><span class=p>,</span> <span class=n>percentage</span><span class=p>,</span> <span class=n>n</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>token</span> <span class=ow>in</span> <span class=n>tokenizer</span><span class=p>(</span><span class=n>document</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>token</span> <span class=o>=</span> <span class=n>token</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=c1># Check for percentages.</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>token</span><span class=o>.</span><span class=n>isnumeric</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>material</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>percentage</span> <span class=o>+=</span> <span class=nb>float</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># Number of component is equal to the total sum of percentage / 100</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>percentage</span> <span class=o>&gt;=</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>component</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>n</span><span class=p>[</span><span class=n>component</span><span class=p>]</span> <span class=o>=</span> <span class=n>material</span>
</span></span><span class=line><span class=cl>            <span class=n>percentage</span><span class=p>,</span> <span class=n>material</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract</span><span class=p>(</span><span class=n>tokenizer</span><span class=p>,</span> <span class=n>qa</span><span class=p>,</span> <span class=n>document</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Extract fields from the document.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>answers</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>document</span> <span class=o>=</span> <span class=n>clean</span><span class=p>(</span><span class=n>document</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>component</span><span class=p>,</span> <span class=n>materials</span> <span class=ow>in</span> <span class=n>n_components_materials</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>tokenizer</span><span class=o>=</span><span class=n>tokenizer</span><span class=p>,</span> <span class=n>document</span><span class=o>=</span><span class=n>document</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=c1># Ask about the component</span>
</span></span><span class=line><span class=cl>        <span class=n>component</span> <span class=o>=</span> <span class=n>qa</span><span class=p>({</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;What is the </span><span class=si>{</span><span class=n>component</span><span class=si>}</span><span class=s2> component ?&#34;</span><span class=p>,</span> <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>document</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=n>component</span> <span class=o>=</span> <span class=n>component</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>material</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>materials</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># Ask about the material and the proportion</span>
</span></span><span class=line><span class=cl>            <span class=n>answer</span> <span class=o>=</span> <span class=n>qa</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;What is the </span><span class=si>{</span><span class=n>material</span><span class=si>}</span><span class=s2> material of the component </span><span class=si>{</span><span class=n>component</span><span class=si>}</span><span class=s2> ?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>document</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>material</span><span class=p>,</span> <span class=n>score</span> <span class=o>=</span> <span class=n>answer</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>],</span> <span class=n>answer</span><span class=p>[</span><span class=s2>&#34;score&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Extract proportion</span>
</span></span><span class=line><span class=cl>            <span class=n>proportion</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;\d+&#34;</span><span class=p>,</span> <span class=n>material</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>material</span> <span class=o>=</span> <span class=n>material</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>proportion</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>answers</span><span class=p>[</span><span class=n>component</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=n>material</span><span class=p>,</span> <span class=s2>&#34;proportion&#34;</span><span class=p>:</span> <span class=nb>float</span><span class=p>(</span><span class=n>proportion</span><span class=p>),</span> <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=nb>round</span><span class=p>(</span><span class=n>score</span><span class=p>,</span> <span class=mi>4</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>dict</span><span class=p>(</span><span class=n>answers</span><span class=p>)</span>
</span></span></code></pre></div></details><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>spacy</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>spacy</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&#34;en_core_web_sm&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>document</span> <span class=o>=</span> <span class=s2>&#34;body: 83% nylon 17</span><span class=si>% s</span><span class=s2>pandex; lace: 86% nylon 14</span><span class=si>% s</span><span class=s2>pandex&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>extract</span><span class=p>(</span><span class=n>tokenizer</span><span class=o>=</span><span class=n>tokenizer</span><span class=p>,</span> <span class=n>qa</span><span class=o>=</span><span class=n>qa</span><span class=p>,</span> <span class=n>document</span><span class=o>=</span><span class=n>document</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;body&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;nylon&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>83.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>17.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lace&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;nylon&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>86.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>14.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=entity-linking>Entity linking</h2><p>We are almost there. The last step is to perform entity linking on the components and materials. To do this, we can use the library Cherche <a href=https://github.com/raphaelsty/cherche>shameless self-promotion</a>. Finally, we use a simple tf-idf for components and materials to try to correct any typos in the documents.</p><p>We must define all the components and materials to proceed to the entity linking phase.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>components</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1># The [NONE] component is dedicated to missing components.</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;[NONE]&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;front_panel&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;front panel&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;shell&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;shell&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;crochet&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;crochet&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;g-string&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;g-string&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;panty&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;panty&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;bottom&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;bottom&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;striped_mesh&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;striped mesh&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;marl_fabric&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;marl fabric&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;tank&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;tank&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;centre_front_and_wings&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;centre front and wings&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;ank&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;ank&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;top_body&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;top body&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;body_panty&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;body panty&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;mesh&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;mesh&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;pant&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;pant&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;aol&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;aol&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;cup_shell&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;cup shell&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;ruffle&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;ruffle&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;elastic&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;elastic&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;lace&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;lace&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;fabric&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;fabric&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;liner&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;liner&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;body&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;body&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;top&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;top&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;forro&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;forro&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;lining&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;lining&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;rib&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;rib&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;cup_lining&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;cup lining&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;back_panel&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;back panel&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;trim_lace&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;trim lace&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;micro&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;micro&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;cami&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;cami&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;gusset&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;gusset&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;edge_lace&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;edge lace&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;short&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;short&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;knitted_top&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;knitted top&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;component&#34;</span><span class=p>:</span> <span class=s2>&#34;pants&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;pants&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>materials</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;cotton&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;cotton&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;organic cotton&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;organic cotton&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;modal&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;modal&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;nylon&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;nylon&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;elastane&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;elastane&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;eco vero rayon&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;eco vero rayon&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;regular polyamide&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;regular polyamide&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;polyester&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;polyester&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;recycled polyamide&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;recycled polyamide&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;rayon&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;rayon&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;recycled nylon&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;recycled nylon&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;recycled polyester&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;recycled polyester&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;acrylique&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;acrylique&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;polyamide&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;polyamide&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;viscose&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;viscose&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;lycra&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;lycra&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;cotton woven top&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;cotton woven top&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;polyester knitted&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;polyester knitted&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;ecovero viscose&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;ecovero viscose&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;bamboo&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;bamboo&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;metallic yarn&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;metallic yarn&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;recycled cotton&#34;</span><span class=p>,</span> <span class=s2>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;recycled cotton&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>We can then instantiate our entity linking models:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>cherche</span> <span class=kn>import</span> <span class=n>retrieve</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.feature_extraction.text</span> <span class=kn>import</span> <span class=n>TfidfVectorizer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>retriever_material</span> <span class=o>=</span> <span class=n>retrieve</span><span class=o>.</span><span class=n>TfIdf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span><span class=o>=</span><span class=s2>&#34;material&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>on</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;label&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span><span class=o>=</span><span class=n>materials</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tfidf</span><span class=o>=</span><span class=n>TfidfVectorizer</span><span class=p>(</span><span class=n>lowercase</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ngram_range</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span> <span class=n>analyzer</span><span class=o>=</span><span class=s2>&#34;char_wb&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>retriever_component</span> <span class=o>=</span> <span class=n>retrieve</span><span class=o>.</span><span class=n>TfIdf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span><span class=o>=</span><span class=s2>&#34;component&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>on</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;label&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span><span class=o>=</span><span class=n>components</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tfidf</span><span class=o>=</span><span class=n>TfidfVectorizer</span><span class=p>(</span><span class=n>lowercase</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ngram_range</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span> <span class=n>analyzer</span><span class=o>=</span><span class=s2>&#34;char_wb&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>The tf-idf retriever associated with ngrams can correct some of the typos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># recycled polyester</span>
</span></span><span class=line><span class=cl><span class=n>retriever_material</span><span class=p>(</span><span class=s2>&#34;plyestr recy&#34;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;recycled polyester&#34;</span><span class=p>,</span> <span class=nt>&#34;similarity&#34;</span><span class=p>:</span> <span class=mf>0.39</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;polyester&#34;</span><span class=p>,</span> <span class=nt>&#34;similarity&#34;</span><span class=p>:</span> <span class=mf>0.28016</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;recycled cotton&#34;</span><span class=p>,</span> <span class=nt>&#34;similarity&#34;</span><span class=p>:</span> <span class=mf>0.21709</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;recycled nylon&#34;</span><span class=p>,</span> <span class=nt>&#34;similarity&#34;</span><span class=p>:</span> <span class=mf>0.21686</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;polyester knitted&#34;</span><span class=p>,</span> <span class=nt>&#34;similarity&#34;</span><span class=p>:</span> <span class=mf>0.19697</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;recycled polyamide&#34;</span><span class=p>,</span> <span class=nt>&#34;similarity&#34;</span><span class=p>:</span> <span class=mf>0.17656</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;regular polyamide&#34;</span><span class=p>,</span> <span class=nt>&#34;similarity&#34;</span><span class=p>:</span> <span class=mf>0.02398</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><h2 id=overall-pipeline>Overall pipeline</h2><p>Here we are. Below is the complete pipeline, consisting of an extractive question-answering model and an entity disambiguation pipeline.</p><p>All the code dedicated to inference:</p><details><summary>Click to see the code</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>collections</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>spacy</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>cherche</span> <span class=kn>import</span> <span class=n>retrieve</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.feature_extraction.text</span> <span class=kn>import</span> <span class=n>TfidfVectorizer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>transformers</span> <span class=kn>import</span> <span class=n>pipeline</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>qa</span> <span class=o>=</span> <span class=n>pipeline</span><span class=p>(</span><span class=s1>&#39;question-answering&#39;</span><span class=p>,</span> <span class=n>model</span><span class=o>=</span><span class=s2>&#34;raphaelsty/carbonblog&#34;</span><span class=p>,</span> <span class=n>tokenizer</span><span class=o>=</span><span class=s2>&#34;raphaelsty/carbonblog&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>spacy</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&#34;en_core_web_sm&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>clean</span><span class=p>(</span><span class=n>document</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Pre-process the document.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>document</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;[^a-zA-Z0-9 </span><span class=se>\n</span><span class=s2>\.]&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=n>document</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>document</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;\s\s+&#34;</span> <span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=n>document</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># [NONE] allows the model to handle missing components.</span>
</span></span><span class=line><span class=cl>    <span class=n>document</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;[NONE] </span><span class=si>{</span><span class=n>document</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>document</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>n_components_materials</span><span class=p>(</span><span class=n>tokenizer</span><span class=p>,</span> <span class=n>document</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Extract the number of components and materials per component.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>component</span><span class=p>,</span> <span class=n>material</span><span class=p>,</span> <span class=n>percentage</span><span class=p>,</span> <span class=n>n</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>token</span> <span class=ow>in</span> <span class=n>tokenizer</span><span class=p>(</span><span class=n>document</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>token</span> <span class=o>=</span> <span class=n>token</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>        <span class=c1># Check for percentages.</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>token</span><span class=o>.</span><span class=n>isnumeric</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>material</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>percentage</span> <span class=o>+=</span> <span class=nb>float</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># Number of component is equal to the total sum of percentage / 100</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>percentage</span> <span class=o>&gt;=</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>component</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>n</span><span class=p>[</span><span class=n>component</span><span class=p>]</span> <span class=o>=</span> <span class=n>material</span>
</span></span><span class=line><span class=cl>            <span class=n>percentage</span><span class=p>,</span> <span class=n>material</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract</span><span class=p>(</span><span class=n>tokenizer</span><span class=p>,</span> <span class=n>qa</span><span class=p>,</span> <span class=n>document</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Extract fields from the document.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>answers</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>document</span> <span class=o>=</span> <span class=n>clean</span><span class=p>(</span><span class=n>document</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>component</span><span class=p>,</span> <span class=n>materials</span> <span class=ow>in</span> <span class=n>n_components_materials</span><span class=p>(</span><span class=n>tokenizer</span><span class=o>=</span><span class=n>tokenizer</span><span class=p>,</span> <span class=n>document</span><span class=o>=</span><span class=n>document</span><span class=p>)</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=c1># Ask about the component</span>
</span></span><span class=line><span class=cl>        <span class=n>component</span> <span class=o>=</span> <span class=n>qa</span><span class=p>({</span><span class=s1>&#39;question&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;What is the </span><span class=si>{</span><span class=n>component</span><span class=si>}</span><span class=s2> component ?&#34;</span><span class=p>,</span> <span class=s1>&#39;context&#39;</span><span class=p>:</span> <span class=n>document</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=n>component</span> <span class=o>=</span> <span class=n>component</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>material</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>materials</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># Ask about the material and the proportion</span>
</span></span><span class=line><span class=cl>            <span class=n>answer</span> <span class=o>=</span> <span class=n>qa</span><span class=p>({</span><span class=s1>&#39;question&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;What is the </span><span class=si>{</span><span class=n>material</span><span class=si>}</span><span class=s2> material of the component </span><span class=si>{</span><span class=n>component</span><span class=si>}</span><span class=s2> ?&#34;</span><span class=p>,</span> <span class=s1>&#39;context&#39;</span><span class=p>:</span> <span class=n>document</span><span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=n>material</span><span class=p>,</span> <span class=n>score</span> <span class=o>=</span> <span class=n>answer</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>],</span> <span class=n>answer</span><span class=p>[</span><span class=s2>&#34;score&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Extract proportion</span>
</span></span><span class=line><span class=cl>            <span class=n>proportion</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\d+&#39;</span><span class=p>,</span> <span class=n>material</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>material</span> <span class=o>=</span> <span class=n>material</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>proportion</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>answers</span><span class=p>[</span><span class=n>component</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=n>material</span><span class=p>,</span> <span class=s2>&#34;proportion&#34;</span><span class=p>:</span> <span class=nb>float</span><span class=p>(</span><span class=n>proportion</span><span class=p>),</span> <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=nb>round</span><span class=p>(</span><span class=n>score</span><span class=p>,</span> <span class=mi>4</span><span class=p>)})</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>dict</span><span class=p>(</span><span class=n>answers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>components</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1># Component [NONE] -&gt; &#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;[NONE]&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;front_panel&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;front panel&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;shell&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;shell&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;crochet&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;crochet&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;g-string&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;g-string&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;panty&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;panty&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;bottom&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;bottom&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;striped_mesh&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;striped mesh&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;marl_fabric&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;marl fabric&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;tank&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;tank&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;centre_front_and_wings&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;centre front and wings&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;ank&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;ank&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;string&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;string&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;top_body&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;top body&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;body_panty&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;body panty&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;mesh&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;mesh&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;pant&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;pant&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;aol&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;aol&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;cup_shell&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;cup shell&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;ruffle&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;ruffle&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;elastic&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;elastic&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;lace&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;lace&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;fabric&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;fabric&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;liner&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;liner&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;body&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;body&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;top&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;top&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;forro&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;forro&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;lining&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;lining&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;rib&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;rib&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;cup_lining&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;cup lining&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;back_panel&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;back panel&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;trim_lace&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;trim lace&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;micro&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;micro&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;cami&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;cami&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;gusset&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;gusset&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;edge_lace&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;edge lace&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;short&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;short&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;knitted_top&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;knitted top&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;component&#39;</span><span class=p>:</span> <span class=s1>&#39;pants&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;pants&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>materials</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;cotton&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;cotton&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;organic cotton&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;organic cotton&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;modal&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;modal&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;nylon&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;nylon&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;elastane&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;elastane&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;eco vero rayon&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;eco vero rayon&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;regular polyamide&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;regular polyamide&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;polyester&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;polyester&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;recycled polyamide&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;recycled polyamide&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;rayon&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;rayon&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;recycled nylon&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;recycled nylon&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;recycled polyester&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;recycled polyester&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;acrylique&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;acrylique&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;spandex&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;spandex&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;polyamide&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;polyamide&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;viscose&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;viscose&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;lycra&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;lycra&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;cotton woven top&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;cotton woven top&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;polyester knitted&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;polyester knitted&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;ecovero viscose&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;ecovero viscose&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;bamboo&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;bamboo&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;metallic yarn&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;metallic yarn&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s1>&#39;material&#39;</span><span class=p>:</span> <span class=s1>&#39;recycled cotton&#39;</span><span class=p>,</span> <span class=s1>&#39;label&#39;</span><span class=p>:</span> <span class=s1>&#39;recycled cotton&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>retriever_material</span> <span class=o>=</span> <span class=n>retrieve</span><span class=o>.</span><span class=n>TfIdf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=s2>&#34;material&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>on</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;label&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>documents</span> <span class=o>=</span> <span class=n>materials</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>tfidf</span> <span class=o>=</span> <span class=n>TfidfVectorizer</span><span class=p>(</span><span class=n>lowercase</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ngram_range</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span> <span class=n>analyzer</span><span class=o>=</span><span class=s2>&#34;char_wb&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>retriever_component</span> <span class=o>=</span> <span class=n>retrieve</span><span class=o>.</span><span class=n>TfIdf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=s2>&#34;component&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>on</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;label&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span> <span class=o>=</span> <span class=n>components</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tfidf</span> <span class=o>=</span> <span class=n>TfidfVectorizer</span><span class=p>(</span><span class=n>lowercase</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ngram_range</span><span class=o>=</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span> <span class=n>analyzer</span><span class=o>=</span><span class=s2>&#34;char_wb&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>parse</span><span class=p>(</span><span class=n>tokenizer</span><span class=p>,</span> <span class=n>qa</span><span class=p>,</span> <span class=n>document</span><span class=p>,</span> <span class=n>retriever_material</span><span class=p>,</span> <span class=n>retriever_component</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Ask questions and retrieves components and materials using Cherche.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>items</span> <span class=o>=</span> <span class=n>extract</span><span class=p>(</span><span class=n>tokenizer</span><span class=o>=</span><span class=n>tokenizer</span><span class=p>,</span> <span class=n>qa</span><span class=o>=</span><span class=n>qa</span><span class=p>,</span> <span class=n>document</span><span class=o>=</span><span class=n>document</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error parsing document:</span><span class=se>\n\t</span><span class=si>{</span><span class=n>document</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>components_materials</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>component</span><span class=p>,</span> <span class=n>materials</span> <span class=ow>in</span> <span class=n>items</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Retrieve the right component.</span>
</span></span><span class=line><span class=cl>        <span class=n>component_found</span> <span class=o>=</span> <span class=n>retriever_component</span><span class=p>(</span><span class=n>component</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>component_found</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>component_found</span> <span class=o>=</span> <span class=n>component_found</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s2>&#34;component&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unable to retrieve component document:</span><span class=se>\n\t</span><span class=si>{</span><span class=n>document</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>material</span> <span class=ow>in</span> <span class=n>materials</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Retrieve the right material.</span>
</span></span><span class=line><span class=cl>            <span class=n>material_found</span> <span class=o>=</span> <span class=n>retriever_material</span><span class=p>(</span><span class=n>material</span><span class=p>[</span><span class=s2>&#34;material&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>material_found</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>material_found</span> <span class=o>=</span> <span class=n>material_found</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s2>&#34;material&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>components_materials</span><span class=p>[</span><span class=n>component_found</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=n>material_found</span><span class=p>,</span> <span class=s2>&#34;proportion&#34;</span><span class=p>:</span> <span class=n>material</span><span class=p>[</span><span class=s2>&#34;proportion&#34;</span><span class=p>],</span> <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>material</span><span class=p>[</span><span class=s2>&#34;score&#34;</span><span class=p>]})</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unable to retrieve component document:</span><span class=se>\n\t</span><span class=si>{</span><span class=n>document</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>dict</span><span class=p>(</span><span class=n>components_materials</span><span class=p>)</span>
</span></span></code></pre></div></details><p>Example of application of the pipeline on a set of various descriptions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;top body: 100% polyester lace: 88% nylon 12</span><span class=si>% s</span><span class=s2>pandex, string: 88% nylon 12</span><span class=si>% s</span><span class=s2>pandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;92% polyester, 8</span><span class=si>% s</span><span class=s2>pandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;95</span><span class=si>% r</span><span class=s2>ayon 5</span><span class=si>% s</span><span class=s2>pandex&#34;</span> <span class=s2>&#34;lace 87% nylon 13</span><span class=si>% s</span><span class=s2>pandex; mesh: 95% nylon 5</span><span class=si>% s</span><span class=s2>pandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;body &amp; panty: 85% nylon 15</span><span class=si>% s</span><span class=s2>pandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;86%polyamide,14</span><span class=si>%e</span><span class=s2>lastane&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>document</span> <span class=ow>in</span> <span class=n>documents</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>parse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>tokenizer</span><span class=o>=</span><span class=n>tokenizer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>qa</span><span class=o>=</span><span class=n>qa</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>document</span><span class=o>=</span><span class=n>document</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>retriever_material</span><span class=o>=</span><span class=n>retriever_material</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>retriever_component</span><span class=o>=</span><span class=n>retriever_component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></div><p>Pipeline predictions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;body&#34;</span><span class=p>:</span> <span class=p>[{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;polyester&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>100.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>}],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lace&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;nylon&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>88.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>12.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;string&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;nylon&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>88.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>12.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>0.8396</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;polyester&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>92.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>8.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;rayon&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>95.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>5.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lace&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;nylon&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>87.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>13.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;mesh&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;nylon&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>95.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>0.6435</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>5.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>0.9969</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;body_panty&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;nylon&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>85.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>15.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;polyamide&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>86.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;elastane&#34;</span><span class=p>,</span> <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>14.0</span><span class=p>,</span> <span class=nt>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=evaluation>Evaluation</h2><p>An evaluation of the results of the pipeline on 500 documents (test set) shows that the pipeline finds 96% of the fields on average. I leave the detailed analysis of the model&rsquo;s errors to another time.</p><table><thead><tr><th style=text-align:center>Field</th><th style=text-align:center>Precision</th></tr></thead><tbody><tr><td style=text-align:center>component</td><td style=text-align:center>96.61</td></tr><tr><td style=text-align:center>material</td><td style=text-align:center>96.19</td></tr><tr><td style=text-align:center>proportion</td><td style=text-align:center>96.32</td></tr></tbody></table><p>Below is the code associated with the pipeline evaluation:</p><details><summary>Click to see the code</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>collections</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tqdm</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>river</span> <span class=kn>import</span> <span class=n>stats</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;./data/inputs.txt&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>readlines</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Remove \n</span>
</span></span><span class=line><span class=cl><span class=n>inputs</span> <span class=o>=</span> <span class=p>[</span><span class=n>x</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>inputs</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;./data/outputs.json&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>outputs</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>inputs</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>outputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>missed</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>accuracy_components</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>Mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>accuracy_materials</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>Mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>accuracy_proportions</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>Mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>error_components</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>error_materials</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>error_proportions</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=o>.</span><span class=n>tqdm</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>inputs</span><span class=p>[:</span><span class=mi>500</span><span class=p>],</span> <span class=n>outputs</span><span class=p>[:</span><span class=mi>500</span><span class=p>]),</span> <span class=n>position</span><span class=o>=</span><span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>y_pred</span> <span class=o>=</span> <span class=n>parse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>tokenizer</span><span class=o>=</span><span class=n>tokenizer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>qa</span><span class=o>=</span><span class=n>qa</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>document</span><span class=o>=</span><span class=n>x</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>retriever_material</span><span class=o>=</span><span class=n>retriever_material</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>retriever_component</span><span class=o>=</span><span class=n>retriever_component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>missed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>component</span><span class=p>,</span> <span class=n>materials</span> <span class=ow>in</span> <span class=n>y</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>component</span> <span class=ow>in</span> <span class=n>y_pred</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>accuracy_components</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>material</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>materials</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>material</span><span class=p>[</span><span class=s2>&#34;material&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>y_pred</span><span class=p>[</span><span class=n>component</span><span class=p>][</span><span class=n>idx</span><span class=p>][</span><span class=s2>&#34;material&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>accuracy_materials</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>accuracy_materials</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>error_materials</span><span class=p>[</span><span class=n>material</span><span class=p>[</span><span class=s2>&#34;material&#34;</span><span class=p>]]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>material</span><span class=p>[</span><span class=s2>&#34;proportion&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>y_pred</span><span class=p>[</span><span class=n>component</span><span class=p>][</span><span class=n>idx</span><span class=p>][</span><span class=s2>&#34;proportion&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>accuracy_proportions</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>accuracy_proportions</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>error_proportions</span><span class=p>[</span><span class=n>material</span><span class=p>[</span><span class=s2>&#34;proportion&#34;</span><span class=p>]]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>accuracy_components</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>error_components</span><span class=p>[</span><span class=n>component</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=c1># We are wrong without the right field.</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>material</span> <span class=ow>in</span> <span class=n>materials</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>accuracy_materials</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>accuracy_proportions</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=sa>f</span><span class=s2>&#34;Precision: components </span><span class=si>{</span><span class=n>accuracy_components</span><span class=o>.</span><span class=n>get</span><span class=p>()</span><span class=si>:</span><span class=s2>2f</span><span class=si>}</span><span class=s2>, materials </span><span class=si>{</span><span class=n>accuracy_materials</span><span class=o>.</span><span class=n>get</span><span class=p>()</span><span class=si>:</span><span class=s2>2f</span><span class=si>}</span><span class=s2>, proportion </span><span class=si>{</span><span class=n>accuracy_proportions</span><span class=o>.</span><span class=n>get</span><span class=p>()</span><span class=si>:</span><span class=s2>2f</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div></details><h2 id=there-is-room-for-improvement>There is room for improvement</h2><p>There is plenty of room for improvement. This contribution represents a baseline for further improvements. It can also help facilitate the labeling of new data. The model would benefit from various data-augmentation strategies from knowledge bases like Wordnet.</p><p>Unfortunately, I have not incorporated a feedback loop into this model. For example, we could study the errors and confidence scores of the model in cross-validation to create such a procedure.</p><p>I appreciated the problem that Max posed. In the context of my thesis in NLP at Renault and UniversitÃ© Paul Sabatier, I regularly think about methods for generalization on datasets with a particular vocabulary (different from Wikipedia) and with a reduced number of training data. I think my answer shows that pre-trained extractive question-answering models can identify simple patterns with few examples on real-world datasets.</p></div><script type=text/javascript>var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","MaxHalford/maxhalford.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",null),s.setAttribute("theme","github-light"),document.body.appendChild(s)</script><div class=footer><div class=do-the-thing><div class=elevator><svg class="sweet-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" enable-background="new 0 0 100 100" height="100" width="100"><path d="M70 47.5H30c-1.4.0-2.5 1.1-2.5 2.5v40c0 1.4 1.1 2.5 2.5 2.5h40c1.4.0 2.5-1.1 2.5-2.5V50C72.5 48.6 71.4 47.5 70 47.5zm-22.5 40h-5v-25h5v25zm10 0h-5v-25h5v25zm10 0h-5V60c0-1.4-1.1-2.5-2.5-2.5H40c-1.4.0-2.5 1.1-2.5 2.5v27.5h-5v-35h35v35z"/><path d="M50 42.5c1.4.0 2.5-1.1 2.5-2.5V16l5.7 5.7c.5.5 1.1.7 1.8.7s1.3-.2 1.8-.7c1-1 1-2.6.0-3.5l-10-10c-1-1-2.6-1-3.5.0l-10 10c-1 1-1 2.6.0 3.5 1 1 2.6 1 3.5.0l5.7-5.7v24c0 1.4 1.1 2.5 2.5 2.5z"/></svg>Back to the top</div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.0/elevator.min.js></script>
<script>var elementButton=document.querySelector(".elevator"),elevator=new Elevator({element:elementButton,mainAudio:"/music/elevator.mp3",endAudio:"/music/ding.mp3"})</script><style>.down-arrow{font-size:120px;margin-top:90px;margin-bottom:90px;text-shadow:0 -20px #0c1f31,0 0 #c33329;color:transparent;-webkit-transform:scaleY(.8);-moz-transform:scaleY(.8);transform:scaleY(.8)}.elevator{text-align:center;cursor:pointer;width:140px;margin:auto}.elevator:hover{opacity:.7}.elevator svg{width:40px;height:40px;display:block;margin:auto;margin-bottom:5px}</style><div class=site-footer><div class=site-footer-item><a href=/index.xml><span class=inline-svg><svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path fill="currentcolor" d="M12.8 16C12.8 8.978 7.022 3.2.0 3.2V0c8.777.0 16 7.223 16 16h-3.2zM2.194 11.61c1.21.0 2.195.985 2.195 2.196.0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017.0 13.806c0-1.21.983-2.195 2.194-2.195zM10.606 16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818.0 10.606 4.79 10.606 10.607z"/></svg></span></a></div><div class=site-footer-item><a href=https://github.com/raphaelsty><span class=inline-svg><svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path fill="currentcolor" d="M8 0C3.58.0.0 3.582.0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385.0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953.0-.873.31-1.587.823-2.147-.09-.202-.36-1.015.07-2.117.0.0.67-.215 2.2.82.64-.178 1.32-.266 2-.27.68.004 1.36.092 2 .27 1.52-1.035 2.19-.82 2.19-.82.43 1.102.16 1.915.08 2.117.51.56.82 1.274.82 2.147.0 3.073-1.87 3.75-3.65 3.947.28.24.54.73.54 1.48.0 1.07-.01 1.93-.01 2.19.0.21.14.46.55.38C13.71 14.53 16 11.53 16 8c0-4.418-3.582-8-8-8"/></svg></span></a></div><div class=site-footer-item><a href=https://linkedin.com/in/raphaelsourty><span class=inline-svg><svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path fill="currentcolor" d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235.0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51v1.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4.0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762.0-1.376-.617-1.376-1.377.0-.758.614-1.375 1.376-1.375.76.0 1.376.617 1.376 1.375.0.76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816.0H1.18C.528.0.0.516.0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652.0 1.185-.516 1.185-1.153V1.153C16 .516 15.467.0 14.815.0z" fill-rule="nonzero"/></svg></span></a></div><div class=site-footer-item><a href=https://twitter.com/raphaelsrty><span class=inline-svg><svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path fill="currentcolor" d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.37-1.337.64-2.085.79-.598-.64-1.45-1.04-2.396-1.04-1.812.0-3.282 1.47-3.282 3.28.0.26.03.51.085.75-2.728-.13-5.147-1.44-6.766-3.42C.83 2.58.67 3.14.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21.0-.41-.02-.61-.058.42 1.304 1.63 2.253 3.07 2.28-1.12.88-2.54 1.404-4.07 1.404-.26.0-.52-.015-.78-.045 1.46.93 3.18 1.474 5.04 1.474 6.04.0 9.34-5 9.34-9.33.0-.14.0-.28-.01-.42.64-.46 1.2-1.04 1.64-1.7z" fill-rule="nonzero"/></svg></span></a></div><div class=site-footer-item><a href=https://www.kaggle.com/raphaelsourty><span class=inline-svg><svg role="img" viewBox="0 0 26 26" xmlns="http://www.w3.org/2000/svg"><title>Kaggle icon</title><path fill="currentcolor" d="M18.825 23.859c-.022.092-.117.141-.281.141h-3.139c-.187.0-.351-.082-.492-.248l-5.178-6.589-1.448 1.374v5.111c0 .235-.117.352-.351.352H5.505c-.236.0-.354-.117-.354-.352V.353c0-.233.118-.353.354-.353h2.431c.234.0.351.12.351.353v14.343l6.203-6.272c.165-.165.33-.246.495-.246h3.239c.144.0.236.06.285.18.046.149.034.255-.036.315l-6.555 6.344 6.836 8.507c.095.104.117.208.07.358"/></svg></span></a></div><div class=site-footer-item><a href="https://scholar.google.com/citations?user=cwHNQc0AAAAJ&hl=en"><span class=inline-svg><svg viewBox="0 0 1755 1755" xmlns="http://www.w3.org/2000/svg"><path fill="currentcolor" transform="translate(0 1610) scale(1 -1)" d="M896.76 1130.189c-27.618 30.838-59.618 46.19-95.802 46.19-40.952.0-72.382-14.738-94.288-44.15-21.906-29.322-32.864-64.848-32.864-106.584.0-35.548 5.998-71.738 18-108.64 11.958-36.886 31.524-69.814 58.954-98.838 27.334-29.096 59.144-43.616 95.284-43.616 40.288.0 71.76 13.502 94.332 40.492 22.476 26.954 33.756 60.98 33.756 101.962.0 34.904-5.954 71.454-17.906 109.664-11.894 38.262-31.752 72.784-59.466 103.52zm762.098 382.384c-64.358 64.424-141.86 96.57-232.572 96.57H329.144c-90.712.0-168.14-32.146-232.572-96.57-64.424-64.286-96.57-141.86-96.57-232.572V182.859c0-90.712 32.146-168.288 96.57-232.712 64.432-64.146 142-96.432 232.572-96.432h1097.142c90.712.0 168.214 32.286 232.572 96.57 64.432 64.432 96.644 141.86 96.644 232.572v1097.142c0 90.712-32.22 168.288-96.644 232.572zM1297.81 1154.159V762.033c0-18.154-14.856-33.016-33.016-33.016h-12.156c-18.162.0-33.016 14.856-33.016 33.016v392.126c0 16.12-2.34 29.578 20.188 32.41v52.172l-173.43-142.24c2.004-3.716 3.906-6.092 5.712-9.208 15.242-26.976 23.004-60.526 23.004-101.53.0-31.43-5.238-59.662-15.858-84.598-10.57-24.928-23.428-45.29-38.43-60.972-15.002-15.74-30.048-30.128-45.092-43.074-15.046-12.976-27.904-26.506-38.436-40.55-10.614-14-15.894-28.474-15.894-43.476.0-15.024 6.854-30.288 20.524-45.67 13.62-15.426 30.376-30.376 50.19-45.144 19.85-14.666 39.658-30.946 59.472-48.662 19.858-17.694 36.52-40.456 50.14-68.096 13.722-27.744 20.568-58.288 20.568-91.86.0-44.288-11.294-84.282-33.806-119.882-22.58-35.446-51.998-63.73-88.144-84.472-36.242-20.882-75-36.6-116.334-47.214-41.42-10.518-82.52-15.806-123.568-15.806-25.908.0-52.048 1.996-78.336 6.1-26.382 4.096-52.81 11.33-79.426 21.526-26.668 10.262-50.286 22.864-70.758 37.998-20.524 14.98-37.046 34.312-49.716 57.856-12.668 23.552-18.958 50.022-18.958 79.426.0 34.882 9.714 67.24 29.192 97.404 19.478 29.944 45.282 54.952 77.378 74.76 55.998 34.838 143.858 56.364 263.432 64.498-27.334 34.172-41.048 66.334-41.048 96.432.0 17.122 4.476 35.474 13.334 55.288-14.284-1.996-28.994-3.124-44.002-3.124-64.234.0-118.476 20.882-162.524 62.932-44.046 41.976-66.048 94.522-66.048 158.048.0 6.642.19 12.492.672 18.974H292.574l393.618 342.17h651.856l-60.24-47.024v-82.996c22.368-2.874 20.004-16.318 20.004-32.394zM900.382 544.929c-7.52 1.36-18.088 2.122-31.708 2.122-29.382.0-58.288-2.596-86.666-7.782-28.38-5.046-56.378-13.568-83.998-25.592-27.722-11.952-50.096-29.528-67.146-52.766-17.144-23.208-25.666-50.542-25.666-81.994.0-29.974 7.52-56.714 22.572-80.004 15.002-23.142 34.808-41.26 59.428-54.236 24.62-12.998 50.432-22.814 77.378-29.264 26.998-6.408 54.476-9.736 82.476-9.736 55.376.0 103.05 12.47 143.046 37.406 39.906 24.928 59.904 63.422 59.904 115.382.0 10.928-1.522 21.686-4.528 32.19-3.138 10.62-6.24 19.712-9.282 27.26-3.05 7.41-8.858 16.332-17.43 26.616-8.522 10.314-15.046 17.934-19.434 23.004-4.476 5.238-12.852 12.712-25.19 22.594-12.236 9.926-20.048 16.114-23.522 18.402-3.43 2.406-12.332 8.908-26.668 19.456-14.328 10.634-22.184 16.274-23.566 16.94z"/></svg></span></a></div><div class=site-footer-item><a href=mailto:raphael.sourty@gmail.com><span class=inline-svg><svg viewBox="0 0 15 20" xmlns="http://www.w3.org/2000/svg"><title>mail</title><path fill="currentcolor" d="M0 4v8c0 .55.45 1 1 1h12c.55.0 1-.45 1-1V4c0-.55-.45-1-1-1H1c-.55.0-1 .45-1 1zm13 0L7 9 1 4h12zM1 5.5l4 3-4 3v-6zM2 12l3.5-3L7 10.5 8.5 9l3.5 3H2zm11-.5-4-3 4-3v6z" fill="#000" fill-rule="evenodd"/></svg></span></a></div></div></div></div></article><script></script></body></html>